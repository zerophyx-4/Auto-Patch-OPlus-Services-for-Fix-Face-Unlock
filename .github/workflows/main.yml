name: Auto Patch FaceUnlock

on:
  workflow_dispatch:
    inputs:
      services_url:
        description: 'Direct link to services.jar (must be a direct download URL)'
        required: true
        # default removed – user must provide a valid URL

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # ------------------------------------------------------------
      # Validate input URL (not empty) and download
      # ------------------------------------------------------------
      - name: Download and Validate services.jar
        run: |
          URL="${{ github.event.inputs.services_url }}"
          
          # Fail early if URL is empty
          if [ -z "$URL" ]; then
            echo "❌ No URL provided. Please enter a valid direct download link to services.jar."
            exit 1
          fi

          echo "Downloading from: $URL"

          # Use a realistic User-Agent to avoid being blocked
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

          # Download with follow redirects, capture HTTP code and headers
          HTTP_CODE=$(curl -L -A "$UA" -w "%{http_code}" -o services.jar -D headers.txt "$URL" 2>/dev/null)

          echo "HTTP response code: $HTTP_CODE"
          echo "Response headers:"
          cat headers.txt

          # If not 200, show first 20 lines of what we downloaded (often an error page)
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "❌ HTTP error $HTTP_CODE"
            echo "First 20 lines of downloaded content:"
            head -n 20 services.jar
            exit 1
          fi

          # Check file size (services.jar should be > 1 MB)
          SIZE=$(stat -c%s services.jar 2>/dev/null || stat -f%z services.jar 2>/dev/null)
          echo "Downloaded size: $SIZE bytes"
          if [ "$SIZE" -lt 100000 ]; then
            echo "❌ File too small ($SIZE bytes) – probably not a valid JAR."
            echo "First 20 lines:"
            head -n 20 services.jar
            exit 1
          fi

          # Verify it's a ZIP archive (JAR = ZIP)
          if ! unzip -tq services.jar >/dev/null 2>&1; then
            echo "❌ File is not a valid ZIP/JAR archive."
            echo "File type: $(file -b services.jar)"
            echo "First 20 lines:"
            head -n 20 services.jar
            exit 1
          fi

          echo "✅ Download successful, file is a valid JAR."

      # ------------------------------------------------------------
      # Ensure apktool is present (download if missing)
      # ------------------------------------------------------------
      - name: Ensure apktool is present
        run: |
          if [ ! -f scripts/apktool.jar ]; then
            echo "⚠️ scripts/apktool.jar not found – downloading latest version..."
            mkdir -p scripts
            curl -L -o scripts/apktool.jar https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
          else
            echo "✅ Using existing scripts/apktool.jar"
          fi

      - name: Backup Original META-INF and Resources
        run: |
          mkdir -p backup
          unzip -o services.jar "META-INF/*" "res/*" -d backup/ 2>/dev/null || echo "No META-INF or res to backup"

      - name: Decompile services.jar with Apktool
        run: |
          java -jar scripts/apktool.jar d services.jar -o out_folder

      - name: Restore Backup to Decompiled Folder
        run: |
          if [ -d backup/META-INF ]; then
            cp -r backup/META-INF out_folder/unknown/ 2>/dev/null || echo "Failed to copy META-INF"
          fi
          if [ -d backup/res ]; then
            cp -r backup/res out_folder/unknown/ 2>/dev/null || echo "Failed to copy res"
          fi

      - name: Execute Python Patcher
        run: python3 scripts/patcher.py

      - name: Repack and Inject Class
        run: |
          java -jar scripts/apktool.jar b out_folder -o services_patched.jar

          if [ -f classes5.dex ]; then
            zip -u services_patched.jar classes5.dex
            echo "✅ Injected classes5.dex"
          else
            echo "⚠️ classes5.dex not found, skipping injection"
          fi

          zip -d services_patched.jar "META-INF/*" || echo "No META-INF to remove"

      - name: Prepare Output Package
        run: |
          mkdir -p final_output
          cp services_patched.jar final_output/services.jar

          if [ -d system ]; then
            cp -r system final_output/
          else
            echo "⚠️ system folder not found, skipping"
          fi

          if [ -f README.md ]; then
            cp README.md final_output/
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Patched_FaceUnlock_Build
          path: final_output/

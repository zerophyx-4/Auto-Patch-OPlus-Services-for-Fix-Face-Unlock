name: Patch services.jar

on:
  workflow_dispatch:
    inputs:
      services_url:
        description: 'Direct link to services.jar (Pixeldrain supported)'
        required: true
      disable_secure_screenshot:
        description: 'Disable Secure Screenshot'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Download and Validate services.jar
        run: |
          URL="${{ github.event.inputs.services_url }}"

          if [ -z "$URL" ]; then
            echo "‚ùå No URL provided."
            exit 1
          fi

          # Convert Pixeldrain share link to direct API link
          PD_MATCH=$(echo "$URL" | grep -oP '(?<=pixeldrain\.com/u/)[^/?]+')
          if [ -n "$PD_MATCH" ]; then
            URL="https://pixeldrain.com/api/file/${PD_MATCH}"
            echo "‚úÖ Converted to Pixeldrain API link: $URL"
          fi

          echo "Downloading from: $URL"

          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          HTTP_CODE=$(curl -L -A "$UA" -w "%{http_code}" -o services.jar -D headers.txt "$URL" 2>/dev/null)

          echo "HTTP response code: $HTTP_CODE"
          cat headers.txt

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå HTTP error $HTTP_CODE"
            head -n 20 services.jar
            exit 1
          fi

          SIZE=$(stat -c%s services.jar 2>/dev/null || stat -f%z services.jar 2>/dev/null)
          echo "Downloaded size: $SIZE bytes"
          if [ "$SIZE" -lt 100000 ]; then
            echo "‚ùå File too small ($SIZE bytes) ‚Äì probably not a valid JAR."
            head -n 20 services.jar
            exit 1
          fi

          if ! unzip -tq services.jar >/dev/null 2>&1; then
            echo "‚ùå File is not a valid ZIP/JAR archive."
            echo "File type: $(file -b services.jar)"
            head -n 20 services.jar
            exit 1
          fi

          echo "‚úÖ Download successful, file is a valid JAR."

      - name: Ensure apktool is present
        run: |
          if [ ! -f scripts/apktool.jar ]; then
            echo "‚ö†Ô∏è scripts/apktool.jar not found ‚Äì downloading..."
            mkdir -p scripts
            curl -L -o scripts/apktool.jar https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
          else
            echo "‚úÖ Using existing scripts/apktool.jar"
          fi

      - name: Backup original services.jar
        run: |
          cp services.jar services_original.jar
          mkdir -p backup
          unzip -o services.jar "META-INF/*" "res/*" -d backup/ 2>/dev/null || echo "No META-INF or res to backup"

      - name: Decompile services.jar with Apktool
        run: |
          java -jar scripts/apktool.jar d services.jar -o out_folder

      - name: Restore Backup to Decompiled Folder
        run: |
          if [ -d backup/META-INF ]; then
            cp -r backup/META-INF out_folder/unknown/ 2>/dev/null || echo "Failed to copy META-INF"
          fi
          if [ -d backup/res ]; then
            cp -r backup/res out_folder/unknown/ 2>/dev/null || echo "Failed to copy res"
          fi

      - name: Execute Python Patcher
        env:
          DISABLE_SECURE_SCREENSHOT: ${{ github.event.inputs.disable_secure_screenshot }}
        run: python3 scripts/patcher.py 2>&1 | tee patch.log

      - name: Repack and Inject Class
        run: |
          java -jar scripts/apktool.jar b out_folder -o services_patched.jar 2>&1
          EXIT_CODE=$?

          if [ ! -f services_patched.jar ]; then
            echo "‚ùå services_patched.jar not found after repack!"
            exit 1
          fi

          if [ -f classes5.dex ]; then
            zip -u services_patched.jar classes5.dex
            echo "‚úÖ Injected classes5.dex"
          else
            echo "‚ö†Ô∏è classes5.dex not found, skipping injection"
          fi

          zip -d services_patched.jar "META-INF/*" 2>/dev/null || echo "No META-INF to remove"

          echo "‚úÖ Repack complete"

      - name: Prepare Output Package
        run: |
          mkdir -p final_output/logs

          # Main files
          cp services_patched.jar final_output/services.jar
          cp services_original.jar final_output/services_original.jar

          # System files
          if [ -d system ]; then
            cp -r system final_output/
          else
            echo "‚ö†Ô∏è system folder not found, skipping"
          fi

          # README
          if [ -f README.md ]; then
            cp README.md final_output/
          fi

          # Logs
          cp patch.log final_output/logs/patch.log

          # Magisk Module
          if [ -d magisk_module ]; then
            mkdir -p magisk_module/system/framework
            cp services_patched.jar magisk_module/system/framework/services.jar
            if [ -d system ]; then
              cp -r system/. magisk_module/system/
            fi
            cd magisk_module
            zip -r9 ../final_output/FaceUnlock-Module.zip . 2>/dev/null
            cd ..
            echo "‚úÖ Magisk module created"
          else
            echo "‚ö†Ô∏è magisk_module folder not found, skipping"
          fi

          echo "üì¶ Output contents:"
          ls -la final_output/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: patched-services
          path: final_output/
          compression-level: 9
